services:
    blue:
        build: .
        container_name: pawpong_blue
        ports:
            - '8080:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=blue
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            loki:
                condition: service_started
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - 'deployment=blue'
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
                labels: 'deployment,container_name'

    green:
        build: .
        container_name: pawpong_green
        ports:
            - '8081:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=green
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            loki:
                condition: service_started
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - "deployment=green"
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
                labels: "deployment,container_name"

    # Grafana - 시각화 대시보드
    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        ports:
            - '3000:3000'
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=pawpong2025
            - GF_USERS_ALLOW_SIGN_UP=false
            - GF_SERVER_ROOT_URL=http://localhost:3000
            - GF_INSTALL_PLUGINS=
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # Loki - 로그 수집 및 저장
    loki:
        image: grafana/loki:latest
        container_name: loki
        ports:
            - '3100:3100'
        command: -config.file=/etc/loki/local-config.yaml
        volumes:
            - loki_data:/loki
            - ./loki/loki-config.yaml:/etc/loki/local-config.yaml
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # Promtail - 로그 에이전트 (Docker 로그 수집)
    promtail:
        image: grafana/promtail:latest
        container_name: promtail
        volumes:
            - ./promtail/promtail-config.yaml:/etc/promtail/config.yml
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock
            - ./logs:/app/logs:ro
        command: -config.file=/etc/promtail/config.yml
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

networks:
    pawpong_network:
        driver: bridge

volumes:
    grafana_data:
    loki_data:
