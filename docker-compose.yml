services:
    blue:
        build: .
        container_name: pawpong_blue
        ports:
            - '8080:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=blue
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            loki:
                condition: service_started
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - 'deployment=blue'
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'
                labels: 'deployment,container_name'

    green:
        build: .
        container_name: pawpong_green
        ports:
            - '8081:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=green
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: ["CMD-SHELL", "wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        depends_on:
            loki:
                condition: service_started
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - "deployment=green"
        logging:
            driver: "json-file"
            options:
                max-size: "10m"
                max-file: "3"
                labels: "deployment,container_name"

    # Grafana - 시각화 대시보드
    grafana:
        image: grafana/grafana:latest
        container_name: grafana
        ports:
            - '3000:3000'
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=pawpong2025
            - GF_USERS_ALLOW_SIGN_UP=false
            - GF_SERVER_ROOT_URL=http://localhost:3000
            - GF_INSTALL_PLUGINS=
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # Loki - 로그 수집 및 저장
    loki:
        image: grafana/loki:latest
        container_name: loki
        ports:
            - '3100:3100'
        command: -config.file=/etc/loki/local-config.yaml
        volumes:
            - loki_data:/loki
            - ./loki/loki-config.yaml:/etc/loki/local-config.yaml
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # Promtail - 로그 에이전트 (Docker 로그 수집)
    promtail:
        image: grafana/promtail:latest
        container_name: promtail
        volumes:
            - ./promtail/promtail-config.yaml:/etc/promtail/config.yml
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock
            - ./logs:/app/logs:ro
        command: -config.file=/etc/promtail/config.yml
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

    # Zookeeper - Kafka 의존성
    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: zookeeper
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        volumes:
            - zookeeper_data:/var/lib/zookeeper/data
            - zookeeper_log:/var/lib/zookeeper/log
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    # Kafka - 메시지 브로커 (채팅 + 유저 플로우 로그)
    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: kafka
        depends_on:
            - zookeeper
        ports:
            - '9092:9092'
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
            KAFKA_LOG_RETENTION_HOURS: 168
            KAFKA_LOG_RETENTION_BYTES: 1073741824
        volumes:
            - kafka_data:/var/lib/kafka/data
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M
        healthcheck:
            test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s

    # Kafka UI - 카프카 모니터링 (개발/디버깅용, 프로덕션에서는 제거 가능)
    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: kafka-ui
        depends_on:
            - kafka
        ports:
            - '8090:8080'
        environment:
            KAFKA_CLUSTERS_0_NAME: pawpong-kafka
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

networks:
    pawpong_network:
        driver: bridge

volumes:
    grafana_data:
    loki_data:
    zookeeper_data:
    zookeeper_log:
    kafka_data:
