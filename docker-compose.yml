# =============================================================================
# Pawpong Backend - Docker Compose
# =============================================================================
# 사용법:
#   전체 실행: docker-compose up -d
#   앱만 실행: docker-compose up -d blue green
#   모니터링만: docker-compose up -d loki grafana promtail
#   Kafka 포함: docker-compose --profile kafka up -d
# =============================================================================

services:
    # =========================================================================
    # 앱 서비스 (Blue-Green 배포)
    # =========================================================================
    blue:
        image: pawpong-backend:latest
        build: .
        container_name: pawpong_blue
        ports:
            - '8080:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=blue
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: [ 'CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1' ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - 'deployment=blue'
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    green:
        image: pawpong-backend:latest
        build: .
        container_name: pawpong_green
        ports:
            - '8081:8080'
        env_file:
            - .env.production
        environment:
            - NODE_ENV=production
            - PORT=8080
            - CONTAINER_NAME=green
        volumes:
            - ./logs:/app/logs
            - ./gcp-service-account.json:/app/gcp-service-account.json:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: [ 'CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:8080/api/health || exit 1' ]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
        deploy:
            resources:
                limits:
                    memory: 2G
                reservations:
                    memory: 1G
        labels:
            - 'deployment=green'
        logging:
            driver: 'json-file'
            options:
                max-size: '10m'
                max-file: '3'

    # =========================================================================
    # 모니터링 스택 (Loki + Grafana + Promtail)
    # =========================================================================
    loki:
        image: grafana/loki:2.9.0
        container_name: loki
        ports:
            - '3100:3100'
        command: -config.file=/etc/loki/local-config.yaml
        volumes:
            - loki_data:/loki
            - ./loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        healthcheck:
            test: [ 'CMD-SHELL', 'wget --no-verbose --tries=1 --spider http://localhost:3100/ready || exit 1' ]
            interval: 10s
            timeout: 5s
            retries: 5
            start_period: 20s
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    grafana:
        image: grafana/grafana:10.2.0
        container_name: grafana
        ports:
            - '3000:3000'
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=pawpong2025
            - GF_USERS_ALLOW_SIGN_UP=false
        volumes:
            - grafana_data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning:ro
        restart: unless-stopped
        networks:
            - pawpong_network
        depends_on:
            loki:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    promtail:
        image: grafana/promtail:2.9.0
        container_name: promtail
        volumes:
            - ./promtail/promtail-config.yaml:/etc/promtail/config.yml:ro
            - /var/lib/docker/containers:/var/lib/docker/containers:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        command: -config.file=/etc/promtail/config.yml
        restart: unless-stopped
        networks:
            - pawpong_network
        depends_on:
            loki:
                condition: service_healthy
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

    # =========================================================================
    # Kafka 스택 (채팅 기능용 - 필요시 활성화)
    # 사용: docker-compose --profile kafka up -d
    # =========================================================================
    zookeeper:
        image: confluentinc/cp-zookeeper:7.5.0
        container_name: zookeeper
        profiles:
            - kafka
        environment:
            ZOOKEEPER_CLIENT_PORT: 2181
            ZOOKEEPER_TICK_TIME: 2000
        volumes:
            - zookeeper_data:/var/lib/zookeeper/data
            - zookeeper_log:/var/lib/zookeeper/log
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 512M
                reservations:
                    memory: 256M

    kafka:
        image: confluentinc/cp-kafka:7.5.0
        container_name: kafka
        profiles:
            - kafka
        depends_on:
            - zookeeper
        ports:
            - '9092:9092'
        environment:
            KAFKA_BROKER_ID: 1
            KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
            KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
            KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
            KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
            KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
            KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
            KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
            KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
            KAFKA_LOG_RETENTION_HOURS: 168
            KAFKA_LOG_RETENTION_BYTES: 1073741824
        volumes:
            - kafka_data:/var/lib/kafka/data
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 1G
                reservations:
                    memory: 512M
        healthcheck:
            test: [ 'CMD-SHELL', 'kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1' ]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 60s

    kafka-ui:
        image: provectuslabs/kafka-ui:latest
        container_name: kafka-ui
        profiles:
            - kafka
        depends_on:
            - kafka
        ports:
            - '8090:8080'
        environment:
            KAFKA_CLUSTERS_0_NAME: pawpong-kafka
            KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:29092
            KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
        restart: unless-stopped
        networks:
            - pawpong_network
        deploy:
            resources:
                limits:
                    memory: 256M
                reservations:
                    memory: 128M

networks:
    pawpong_network:
        driver: bridge

volumes:
    grafana_data:
    loki_data:
    zookeeper_data:
    zookeeper_log:
    kafka_data:
