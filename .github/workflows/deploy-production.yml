name: Deploy to Production (115.68.179.77)

on:
    push:
        branches: [main]
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy to Production Server
        runs-on: ubuntu-latest

        steps:
            - name: Send deployment start notification
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚è≥ Production Deployment Started\", \"description\": \"Branch: \`main\`\\nCommit: \`${{ github.sha }}\`\\nTriggered by: ${{ github.actor }}\", \"color\": 16776960, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"

            - name: Deploy to Production Server via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: 115.68.176.129
                  username: root
                  password: ${{ secrets.SERVER_PASSWORD }}
                  script: |
                      set -e
                      echo "=== Deployment Started ==="

                      cd /root/Pawpong_Backend

                      echo "üì• Pulling latest code from main branch..."
                      git pull origin main

                      echo "üî® Starting Blue-Green deployment..."
                      chmod +x gcp_deploy.sh
                      ./gcp_deploy.sh ${{ github.sha }}

                      echo "‚úÖ Deployment completed successfully!"

            - name: Notify Discord on Success
              if: success()
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚úÖ Production Deploy Success\", \"description\": \"Branch: \`main\`\\nCommit: \`${{ github.sha }}\`\\nDeployed by: ${{ github.actor }}\\n\\nüîó [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"color\": 3066993, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"

            - name: Notify Discord on Failure
              if: failure()
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚ùå Production Deploy Failed\", \"description\": \"Branch: \`main\`\\nCommit: \`${{ github.sha }}\`\\nTriggered by: ${{ github.actor }}\\n\\n‚ö†Ô∏è Please check the logs and rollback if necessary.\\n\\nüîó [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"
