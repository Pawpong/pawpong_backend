name: Deploy to GCP (Main)

on:
    push:
        branches: [main]

env:
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
    SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
    INSTANCE_ZONE: ${{ secrets.INSTANCE_ZONE }}
    INSTANCE_NAME: ${{ secrets.INSTANCE_NAME }}
    GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}

jobs:
    build-and-deploy:
        name: Build and Deploy to GCP (Main)
        runs-on: ubuntu-latest

        permissions:
            contents: 'read'
            id-token: 'write'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
                  service_account: '${{ env.GCP_SA_EMAIL }}'

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure Docker for GAR
              run: gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

            - name: Build and push Docker image
              id: docker_build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ env.GAR_LOCATION }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/pawpong-backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Setup SSH for Production Server
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/prod_key
                  chmod 600 ~/.ssh/prod_key
                  ssh-keyscan -H "${{ secrets.PROD_SERVER_HOST }}" >> ~/.ssh/known_hosts || echo "SSH keyscan failed, will use StrictHostKeyChecking=no"

            - name: Deploy to Production Server
              env:
                  GAR_LOCATION: ${{ env.GAR_LOCATION }}
                  GCP_PROJECT_ID: ${{ env.GCP_PROJECT_ID }}
                  SERVICE_NAME: ${{ env.SERVICE_NAME }}
                  COMMIT_SHA: ${{ github.sha }}
              run: |
                  echo "ğŸš€ Starting deployment to production server..."
                  ssh -i ~/.ssh/prod_key -o StrictHostKeyChecking=no root@${{ secrets.PROD_SERVER_HOST }} << ENDSSH > deploy.log 2>&1
                  set -e

                  echo "ğŸ“¦ Authenticating with Artifact Registry..."
                  gcloud auth activate-service-account --key-file=/root/gcp-service-account.json
                  gcloud auth configure-docker ${GAR_LOCATION} --quiet

                  cd /root/pawpong_backend || { echo "âŒ Directory not found"; exit 1; }

                  echo "ğŸ“¥ Pulling latest code..."
                  git pull origin main

                  echo "ğŸ³ Pulling Docker image from Artifact Registry..."
                  IMAGE_TAG="${GAR_LOCATION}/${GCP_PROJECT_ID}/${SERVICE_NAME}/pawpong-backend:${COMMIT_SHA}"
                  docker pull "\$IMAGE_TAG"
                  docker tag "\$IMAGE_TAG" pawpong-backend:latest
                  docker tag "\$IMAGE_TAG" pawpong-backend:${COMMIT_SHA}

                  echo "Running Blue-Green deployment..."
                  bash deploy.sh ${COMMIT_SHA}

                  echo "âœ… Deployment completed successfully!"
                  ENDSSH
                  cat deploy.log
                  echo "DEPLOY_LOG<<EOF" >> $GITHUB_ENV
                  cat deploy.log >> $GITHUB_ENV
                  echo "EOF" >> $GITHUB_ENV

            - name: Send Discord Notification (Success)
              if: success()
              run: |
                  COMMIT_MSG=$(git log -1 --pretty=%s | head -c 100)
                  COMMIT_AUTHOR=$(git log -1 --pretty=%an)
                  COMMIT_SHA=$(git rev-parse --short HEAD)

                  # ë°°í¬ ë¡œê·¸ì—ì„œ í™œì„± ì»¨í…Œì´ë„ˆ ì¶”ì¶œ
                  ACTIVE_CONTAINER=$(echo "$DEPLOY_LOG" | grep -oP 'Active Container: \K(blue|green)' || echo "unknown")
                  ACTIVE_PORT=$(echo "$DEPLOY_LOG" | grep -oP 'Active Container: (?:blue|green) \(port \K[0-9]+' || echo "unknown")

                  # JSON íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
                  COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g')

                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "{
                         \"embeds\": [{
                           \"title\": \"í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ\",
                           \"description\": \"Main ë¸Œëœì¹˜ê°€ í”„ë¡œë•ì…˜ ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\",
                           \"color\": 3066993,
                           \"fields\": [
                             {\"name\": \"ì„œë²„\", \"value\": \"115.68.176.129\", \"inline\": true},
                             {\"name\": \"ë°°í¬ ë°©ì‹\", \"value\": \"Docker Blue-Green\", \"inline\": true},
                             {\"name\": \"í™œì„± ì»¨í…Œì´ë„ˆ\", \"value\": \"${ACTIVE_CONTAINER} (í¬íŠ¸ ${ACTIVE_PORT})\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ SHA\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG_ESCAPED}\", \"inline\": false}
                           ],
                           \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                         }]
                       }" \
                       ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}

            - name: Send Discord Notification (Failure)
              if: failure()
              run: |
                  COMMIT_MSG=$(git log -1 --pretty=%s | head -c 100)
                  COMMIT_AUTHOR=$(git log -1 --pretty=%an)
                  COMMIT_SHA=$(git rev-parse --short HEAD)

                  # ë°°í¬ ë¡œê·¸ì—ì„œ ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì¶”ì¶œ
                  FAILED_CONTAINER=$(echo "$DEPLOY_LOG" | grep -oP '(blue|green) deployment failed' | grep -oP '(blue|green)' || echo "unknown")
                  ROLLBACK_CONTAINER=$(echo "$DEPLOY_LOG" | grep -oP 'Rolling back to \K(blue|green)' || echo "unknown")

                  # ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ ì •ë³´
                  if [ "$FAILED_CONTAINER" != "unknown" ]; then
                    FAIL_INFO="ì‹¤íŒ¨í•œ ì»¨í…Œì´ë„ˆ: ${FAILED_CONTAINER}, ë¡¤ë°± ì™„ë£Œ: ${ROLLBACK_CONTAINER}"
                  else
                    FAIL_INFO="ë°°í¬ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ ë°œìƒ"
                  fi

                  # JSON íŠ¹ìˆ˜ë¬¸ì ì´ìŠ¤ì¼€ì´í”„
                  COMMIT_MSG_ESCAPED=$(echo "$COMMIT_MSG" | sed 's/\\/\\\\/g; s/"/\\"/g; s/\t/\\t/g')

                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "{
                         \"embeds\": [{
                           \"title\": \"í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨\",
                           \"description\": \"Main ë¸Œëœì¹˜ ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ${FAIL_INFO}\",
                           \"color\": 15158332,
                           \"fields\": [
                             {\"name\": \"ì„œë²„\", \"value\": \"115.68.176.129\", \"inline\": true},
                             {\"name\": \"ë°°í¬ ë°©ì‹\", \"value\": \"Docker Blue-Green\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ SHA\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ ì‘ì„±ì\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                             {\"name\": \"ì»¤ë°‹ ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG_ESCAPED}\", \"inline\": false},
                             {\"name\": \"ë¡œê·¸ í™•ì¸\", \"value\": \"[GitHub Actions ë¡œê·¸ ë³´ê¸°](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                           ],
                           \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                         }]
                       }" \
                       ${{ secrets.DISCORD_DEPLOY_WEBHOOK_URL }}
