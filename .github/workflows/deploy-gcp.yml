name: Deploy to GCP (Main)

on:
    push:
        branches: [main]

env:
    GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
    GAR_LOCATION: ${{ secrets.GAR_LOCATION }}
    SERVICE_NAME: ${{ secrets.SERVICE_NAME }}
    INSTANCE_ZONE: ${{ secrets.INSTANCE_ZONE }}
    INSTANCE_NAME: ${{ secrets.INSTANCE_NAME }}
    GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}

jobs:
    build-and-deploy:
        name: Build and Deploy to GCP (Main)
        runs-on: ubuntu-latest

        permissions:
            contents: 'read'
            id-token: 'write'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
                  service_account: '${{ env.GCP_SA_EMAIL }}'

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure Docker for GAR
              run: gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

            - name: Build and push Docker image
              id: docker_build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ env.GAR_LOCATION }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/pawpong-backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Setup SSH for Production Server
              run: |
                  mkdir -p ~/.ssh
                  echo "${{ secrets.PROD_SSH_KEY }}" > ~/.ssh/prod_key
                  chmod 600 ~/.ssh/prod_key
                  ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts

            - name: Deploy to Production Server
              run: |
                  echo "ðŸš€ Starting deployment to production server..."
                  ssh -i ~/.ssh/prod_key -o StrictHostKeyChecking=no root@${{ secrets.PROD_SERVER_HOST }} << 'ENDSSH'
                  set -e

                  echo "ðŸ“¦ Authenticating with Artifact Registry..."
                  gcloud auth activate-service-account --key-file=/root/gcp-service-account.json
                  gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

                  cd /root/pawpong_backend || { echo "âŒ Directory not found"; exit 1; }

                  echo "ðŸ“¥ Pulling latest code..."
                  git pull origin main

                  echo "ðŸ³ Pulling Docker image from Artifact Registry..."
                  IMAGE_TAG="${{ env.GAR_LOCATION }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/pawpong-backend:${{ github.sha }}"
                  docker pull "$IMAGE_TAG"
                  docker tag "$IMAGE_TAG" pawpong-backend:latest

                  echo "ðŸ”„ Running Blue-Green deployment..."
                  bash gcp_deploy.sh ${{ github.sha }}

                  echo "âœ… Deployment completed successfully!"
                  ENDSSH
