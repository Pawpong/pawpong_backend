name: Deploy to Development Server (PM2)

on:
    push:
        branches: [dev]
    workflow_dispatch:

jobs:
    deploy:
        name: Deploy to Dev Server (PM2)
        runs-on: ubuntu-latest

        steps:
            - name: Send deployment start notification
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚è≥ Dev Deployment Started\", \"description\": \"Branch: \`dev\`\\nCommit: \`${{ github.sha }}\`\\nTriggered by: ${{ github.actor }}\", \"color\": 16776960, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"

            - name: Deploy to Development Server via SSH
              uses: appleboy/ssh-action@v1.0.0
              with:
                  host: 115.68.179.77
                  username: root
                  password: ${{ secrets.SERVER_PASSWORD }}
                  script: |
                      set -e
                      echo "=== Dev Deployment Started ==="

                      cd /root/Pawpong_Backend

                      echo "üì• Pulling latest code from dev branch..."
                      git pull origin dev

                      echo "üì¶ Installing dependencies..."
                      yarn install

                      echo "üî® Building application..."
                      yarn build

                      echo "üîÑ Restarting PM2..."
                      pm2 delete all || echo "No PM2 processes to delete"
                      pm2 start ecosystem.config.js --env production
                      pm2 save

                      echo "‚úÖ Dev deployment completed successfully!"

            - name: Notify Discord on Success
              if: success()
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚úÖ Dev Deploy Success\", \"description\": \"Branch: \`dev\`\\nCommit: \`${{ github.sha }}\`\\nDeployed by: ${{ github.actor }}\\n\\nüîó [View Commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\", \"color\": 3066993, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"

            - name: Notify Discord on Failure
              if: failure()
              run: |
                  curl -X POST "${{ secrets.DISCORD_WEBHOOK_URL }}" \
                    -H "Content-Type: application/json" \
                    -d "{\"embeds\": [{\"title\": \"‚ùå Dev Deploy Failed\", \"description\": \"Branch: \`dev\`\\nCommit: \`${{ github.sha }}\`\\nTriggered by: ${{ github.actor }}\\n\\n‚ö†Ô∏è Please check the logs.\\n\\nüîó [View Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"color\": 15158332, \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)\"}]}"
