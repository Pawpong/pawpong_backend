name: Deploy to Development Server

on:
    push:
        branches: [dev, develop]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Configure SSH Connection
              run: |
                  # Secrets 확인
                  if [ -z "${{ secrets.DEV_SERVER_HOST }}" ]; then
                    echo "Error: DEV_SERVER_HOST secret is not set"
                    exit 1
                  fi
                  if [ -z "${{ secrets.DEV_SERVER_SSH_KEY }}" ]; then
                    echo "Error: DEV_SERVER_SSH_KEY secret is not set"
                    exit 1
                  fi

                  mkdir -p ~/.ssh/
                  echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts

                  echo "=== SSH Configuration Complete ==="
                  echo "Target host: ${{ secrets.DEV_SERVER_HOST }}"
                  echo "SSH key configured successfully"

            - name: Test SSH Connection
              run: |
                  echo "=== Testing SSH Connection ==="
                  ssh -v -i ~/.ssh/deploy_key root@${{ secrets.DEV_SERVER_HOST }} 'echo "SSH connection successful!"' 2>&1 | tee ssh_test.log

            - name: Deploy to Development Server
              run: |
                  echo "=== Starting Deployment ==="
                  ssh -v -i ~/.ssh/deploy_key root@${{ secrets.DEV_SERVER_HOST }} << 'EOF'
                    echo "Connected to server as: $(whoami)"
                    echo "Current directory: $(pwd)"
                    echo "Home directory: $HOME"

                    export NVM_DIR="$HOME/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

                    echo "Node.js version: $(node --version)"
                    echo "npm version: $(npm --version)"
                    echo "yarn version: $(yarn --version)"

                    cd /root/pawpong_backend/ || { echo "❌ Directory not found"; exit 1; }
                    echo "Changed to project directory: $(pwd)"

                    git pull origin dev
                    echo "Git pull completed"

                    yarn install
                    echo "Dependencies installed"

                    yarn build
                    echo "Build completed"

                    pm2 delete pawpong-dev || echo "No PM2 process to delete"
                    echo "PM2 process deleted"

                    pm2 start ecosystem.config.js --name pawpong-dev --env development
                    echo "PM2 start completed with development environment"

                    pm2 save
                    echo "PM2 configuration saved"
                  EOF
                  2>&1 | tee deployment.log

            - name: Send Discord Notification (Success)
              if: success()
              run: |
                  COMMIT_MSG=$(git log -1 --pretty=%B)
                  COMMIT_AUTHOR=$(git log -1 --pretty=%an)
                  COMMIT_SHA=$(git rev-parse --short HEAD)

                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "{
                         \"embeds\": [{
                           \"title\": \"개발 서버 배포 성공\",
                           \"description\": \"Dev 브랜치가 개발 서버에 성공적으로 배포되었습니다.\",
                           \"color\": 5763719,
                           \"fields\": [
                             {\"name\": \"서버\", \"value\": \"115.68.179.77\", \"inline\": true},
                             {\"name\": \"배포 방식\", \"value\": \"PM2\", \"inline\": true},
                             {\"name\": \"커밋 SHA\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                             {\"name\": \"커밋 작성자\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                             {\"name\": \"커밋 메시지\", \"value\": \"$COMMIT_MSG\", \"inline\": false}
                           ],
                           \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                         }]
                       }" \
                       ${{ secrets.DISCORD_WEBHOOK_URL }}

            - name: Send Discord Notification (Failure)
              if: failure()
              run: |
                  COMMIT_MSG=$(git log -1 --pretty=%B)
                  COMMIT_AUTHOR=$(git log -1 --pretty=%an)
                  COMMIT_SHA=$(git rev-parse --short HEAD)

                  curl -H "Content-Type: application/json" \
                       -X POST \
                       -d "{
                         \"embeds\": [{
                           \"title\": \"개발 서버 배포 실패\",
                           \"description\": \"Dev 브랜치 배포 중 오류가 발생했습니다.\",
                           \"color\": 15158332,
                           \"fields\": [
                             {\"name\": \"서버\", \"value\": \"115.68.179.77\", \"inline\": true},
                             {\"name\": \"배포 방식\", \"value\": \"PM2\", \"inline\": true},
                             {\"name\": \"커밋 SHA\", \"value\": \"$COMMIT_SHA\", \"inline\": true},
                             {\"name\": \"커밋 작성자\", \"value\": \"$COMMIT_AUTHOR\", \"inline\": true},
                             {\"name\": \"커밋 메시지\", \"value\": \"$COMMIT_MSG\", \"inline\": false},
                             {\"name\": \"로그 확인\", \"value\": \"[GitHub Actions 로그 보기](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\", \"inline\": false}
                           ],
                           \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
                         }]
                       }" \
                       ${{ secrets.DISCORD_WEBHOOK_URL }}

            - name: Check deployment status
              if: failure()
              run: |
                  echo "=== Deployment Failed - Debug Info ==="
                  echo "SSH test log:"
                  if [ -f ssh_test.log ]; then
                    cat ssh_test.log
                  else
                    echo "No ssh_test.log file found"
                  fi
                  echo "Deployment log:"
                  if [ -f deployment.log ]; then
                    cat deployment.log
                  else
                    echo "No deployment.log file found"
                  fi
