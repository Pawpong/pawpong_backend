name: Deploy to Development Server

on:
    push:
        branches: [develop]

jobs:
    deploy:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Configure SSH Connection
              run: |
                  mkdir -p ~/.ssh/
                  echo "${{ secrets.DEV_SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key
                  ssh-keyscan -H ${{ secrets.DEV_SERVER_HOST }} >> ~/.ssh/known_hosts
                  echo "=== SSH Key Debug Info ==="
                  echo "SSH key file permissions:"
                  ls -la ~/.ssh/deploy_key
                  echo "SSH key file size:"
                  wc -c ~/.ssh/deploy_key
                  echo "SSH key first few lines:"
                  head -3 ~/.ssh/deploy_key
                  echo "SSH key last few lines:"
                  tail -3 ~/.ssh/deploy_key
                  echo "SSH key format check:"
                  ssh-keygen -l -f ~/.ssh/deploy_key || echo "Invalid SSH key format"
                  echo "Target host: ${{ secrets.DEV_SERVER_HOST }}"
                  echo "SSH known_hosts:"
                  cat ~/.ssh/known_hosts

                  echo "=== Trying to fix SSH key format ==="
                  cat ~/.ssh/deploy_key | tr -d '\r' > ~/.ssh/deploy_key_fixed
                  mv ~/.ssh/deploy_key_fixed ~/.ssh/deploy_key
                  chmod 600 ~/.ssh/deploy_key

                  echo "After fixing - SSH key format check:"
                  ssh-keygen -l -f ~/.ssh/deploy_key || echo "Still invalid SSH key format"

            - name: Test SSH Connection
              run: |
                  echo "=== Testing SSH Connection ==="
                  ssh -v -i ~/.ssh/deploy_key pawpong@${{ secrets.DEV_SERVER_HOST }} 'echo "SSH connection successful!"' 2>&1 | tee ssh_test.log

            - name: Deploy to Development Server
              run: |
                  echo "=== Starting Deployment ==="
                  ssh -v -i ~/.ssh/deploy_key pawpong@${{ secrets.DEV_SERVER_HOST }} << 'EOF'
                    echo "Connected to server as: $(whoami)"
                    echo "Current directory: $(pwd)"
                    echo "Home directory: $HOME"

                    export NVM_DIR="$HOME/.nvm"
                    [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
                    [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"

                    echo "Node.js version: $(node --version)"
                    echo "npm version: $(npm --version)"
                    echo "yarn version: $(yarn --version)"

                    cd ~/pawpong_backend/ &&
                    echo "Changed to project directory: $(pwd)"
                    git pull &&
                    echo "Git pull completed"

                    pm2 delete all || echo "No PM2 processes to delete"
                    echo "PM2 processes deleted"

                    yarn build &&
                    echo "Build completed"

                    pm2 start ecosystem.config.js --name pawpong-dev --env development &&
                    echo "PM2 start completed with development environment"
                  EOF
                  2>&1 | tee deployment.log

            - name: Check deployment status
              if: failure()
              run: |
                  echo "=== Deployment Failed - Debug Info ==="
                  echo "SSH test log:"
                  if [ -f ssh_test.log ]; then
                    cat ssh_test.log
                  else
                    echo "No ssh_test.log file found"
                  fi
                  echo "Deployment log:"
                  if [ -f deployment.log ]; then
                    cat deployment.log
                  else
                    echo "No deployment.log file found"
                  fi
