name: Deploy to GCP (Test)

on:
    push:
        branches: [gcp-deploy-test]

env:
    GCP_PROJECT_ID: pawpong
    GAR_LOCATION: asia-docker.pkg.dev
    SERVICE_NAME: pawpong-docker
    INSTANCE_ZONE: asia-northeast3-c
    INSTANCE_NAME: pawpong-backend-prod
    GCP_SA_EMAIL: github-actions-deployer@pawpong.iam.gserviceaccount.com

jobs:
    build-and-deploy:
        name: Build and Deploy to GCP (Test)
        runs-on: ubuntu-latest

        permissions:
            contents: 'read'
            id-token: 'write'

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: auth
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: 'projects/${{ secrets.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-actions-pool/providers/github-actions-provider'
                  service_account: '${{ env.GCP_SA_EMAIL }}'

            - name: Set up Docker Buildx
              id: buildx
              uses: docker/setup-buildx-action@v3

            - name: Configure Docker for GAR
              run: gcloud auth configure-docker ${{ env.GAR_LOCATION }} --quiet

            - name: Build and push Docker image
              id: docker_build
              uses: docker/build-push-action@v5
              with:
                  context: .
                  push: true
                  tags: ${{ env.GAR_LOCATION }}/${{ env.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/pawpong-backend:${{ github.sha }}
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

            - name: Set up gcloud CLI
              uses: google-github-actions/setup-gcloud@v2

            - name: Setup SSH Keys for GCP
              run: |
                  echo "Generating SSH keys..."
                  ssh-keygen -t rsa -b 4096 -C "github-actions-${{ github.run_id }}" -f ~/.ssh/gcp_key -N ""
                  echo "Preparing SSH key for metadata..."
                  echo "ubuntu:$(cat ~/.ssh/gcp_key.pub)" > /tmp/gcp_ssh_key.pub
                  echo "Adding SSH key to instance metadata..."
                  gcloud compute instances add-metadata ${{ env.INSTANCE_NAME }} \
                    --metadata-from-file ssh-keys=/tmp/gcp_ssh_key.pub \
                    --zone=${{ env.INSTANCE_ZONE }} \
                    --project=${{ env.GCP_PROJECT_ID }}
                  echo "Setting SSH key permissions..."
                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh
                  chmod 600 ~/.ssh/gcp_key
                  echo "Host *" > ~/.ssh/config
                  echo "  StrictHostKeyChecking no" >> ~/.ssh/config
                  echo "  UserKnownHostsFile /dev/null" >> ~/.ssh/config
                  chmod 600 ~/.ssh/config

            - name: Deploy to GCP Instance via IAP Tunnel
              run: |
                  echo "Triggering deployment script on GCP instance via IAP Tunnel..."
                  ssh -v -o ProxyCommand="gcloud compute start-iap-tunnel ${{ env.INSTANCE_NAME }} %p --listen-on-stdin --project=${{ env.GCP_PROJECT_ID }} --zone=${{ env.INSTANCE_ZONE }} --verbosity=warning" \
                    -i ~/.ssh/gcp_key \
                    ubuntu@${{ env.INSTANCE_NAME }} \
                    "sudo /home/ubuntu/pawpong_backend/gcp_deploy.sh ${{ github.sha }}"
